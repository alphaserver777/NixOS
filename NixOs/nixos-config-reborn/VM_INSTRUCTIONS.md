# Инструкция по управлению VM с Windows 10 на QEMU

Этот файл содержит инструкции по установке, запуску и управлению виртуальной машиной Windows 10 с использованием QEMU/KVM.

## 1. Системные требования

Ваша система NixOS должна быть настроена следующим образом:

- Установлен пакет `qemu`.
- Ваш пользователь должен состоять в группе `kvm` для аппаратного ускорения.

(Эти шаги уже выполнены.)

## 2. Первоначальная установка Windows

Эти шаги выполняются только один раз.

### Шаг 1: Создание виртуального диска

Создается файл-образ, который будет служить жестким диском для ВМ.

```bash
qemu-img create -f qcow2 /home/admsys/vms/win10.qcow2 64G
```

### Шаг 2: Запуск установки с ISO-образа

Эта команда запускает ВМ, загружая ее с установочного ISO-образа Windows.

```bash
qemu-system-x86_64 \
    -enable-kvm \
    -M q35 \
    -m 4G \
    -cpu host \
    -smp 4 \
    -hda /home/admsys/vms/win10.qcow2 \
    -cdrom '/home/admsys/Загрузки/Windows 10 LTSB 1607 v14393.8422 rus x64 SuperLite by Revision.iso' \
    -boot d \
    -device usb-ehci \
    -device usb-tablet \
    --display gtk,gl=on
```

В появившемся окне следуйте стандартной процедуре установки Windows.

## 3. Управление виртуальной машиной

### Запуск ВМ (после установки)

Для запуска уже установленной системы Windows используйте следующую команду. Обратите внимание, что опции `-cdrom` и `-boot d` убраны.

```bash
qemu-system-x86_64 \
    -enable-kvm \
    -M q35 \
    -m 4G \
    -cpu host \
    -smp 4 \
    -hda /home/admsys/vms/win10.qcow2 \
    -device usb-ehci \
    -device usb-tablet \
    --display gtk,gl=on
```

### Остановка ВМ

Есть два способа остановить машину:

1.  **Корректный (рекомендуется):** Завершите работу Windows через меню "Пуск" внутри самой виртуальной машины. Окно QEMU закроется автоматически.
2.  **Принудительный:** Закрытие окна QEMU равносильно выдергиванию шнура питания из розетки настоящего компьютера. Используйте это, только если система внутри ВМ полностью зависла.

### Монитор QEMU (для продвинутых пользователей)

В окне QEMU вы можете переключиться в консоль монитора, нажав `Ctrl+Alt+2`. Чтобы вернуться обратно в ВМ, нажмите `Ctrl+Alt+1`.

Из монитора можно отправлять команды. Например, команда для корректного выключения:

```
system_powerdown
```

## 4. Настройка общей папки (Samba)

Эти шаги позволяют создать сетевую папку для обмена файлами между основной системой (NixOS) и виртуальной машиной (Windows).

### Шаг 1: Настройка NixOS

Добавьте следующий блок в ваш файл `configuration.nix`:

```nix
services.samba = {
  enable = true;
  shares = {
    public = {
      path = "/home/admsys/PublicShare"; # Укажите путь к вашей папке
      browseable = "yes";
      "read only" = "no";
      "create mask" = "0664";
      "directory mask" = "0775";
      "valid users" = "admsys"; # Укажите вашего пользователя
    };
  };
};
```

После добавления выполните команду для пересборки системы:
`sudo nixos-rebuild switch --flake .#Huawei`

### Шаг 2: Создание пароля Samba

После пересборки системы, выполните эту команду в терминале, чтобы задать отдельный пароль для доступа к сетевой папке:

```bash
sudo smbpasswd -a admsys
```

### Шаг 3: Подключение из Windows

1.  Запустите вашу виртуальную машину.
2.  Откройте "Проводник" (File Explorer).
3.  В адресную строку введите `\\10.0.2.2\public` и нажмите Enter.
4.  В окне ввода учетных данных введите:
    *   **Имя пользователя:** `admsys`
    *   **Пароль:** пароль, который вы задали на Шаге 2.