### Инструкция по работе со съемными носителями в Linux (флешки, USB-диски, DVD)

Эта инструкция поможет вам научиться работать со съемными носителями данных в командной строке Linux.

#### 1. Просмотр подключенных устройств

Когда вы подключаете устройство (USB-флешку, внешний диск, DVD), система присваивает ему специальное имя файла в каталоге `/dev`. Чтобы увидеть список всех блочных устройств и их разделов, используйте команду `lsblk`:

```bash
lsblk
```

В выводе этой команды вы увидите имена устройств (например, `sda`, `sdb`, `sr0`) и их разделы (`sda1`, `sdb1`). USB-накопители обычно получают имена `sdX` (где X - буква a, b, c...), а DVD-приводы - `srX` (где X - цифра 0, 1...).

#### 2. Монтирование устройства (подключение)

Чтобы получить доступ к файлам на устройстве, его необходимо "смонтировать" в один из каталогов файловой системы.

**a) Создание точки монтирования:**

Точка монтирования — это пустой каталог, в который будет "подключено" содержимое вашего устройства. Вы можете создать его где угодно, но принято использовать подкаталоги в `/mnt` или `/media`.

```bash
sudo mkdir -p /mnt/mydevice
```
*(Вы можете использовать любое имя вместо `mydevice`)*

**b) Процесс монтирования:**

Теперь используйте команду `mount`, чтобы связать ваше устройство с созданным каталогом. Вам понадобятся права суперпользователя (`sudo`).

```bash
# Для USB-флешки или внешнего диска (например, /dev/sdb1)
sudo mount /dev/sdb1 /mnt/mydevice

# Для DVD-диска (например, /dev/sr0)
sudo mount /dev/sr0 /mnt/mydevice
```

*Примечание: В современных дистрибутивах Linux многие рабочие окружения (GNOME, KDE) автоматически монтируют устройства при подключении. Обычно они появляются в каталогах `/media/YOUR_USERNAME/DEVICE_LABEL`.*

#### 3. Доступ к файлам

После успешного монтирования все файлы и папки на вашем устройстве будут доступны в точке монтирования, как если бы они были частью вашей основной файловой системы.

```bash
# Посмотреть список файлов
ls /mnt/mydevice

# Скопировать файл с устройства в домашний каталог
cp /mnt/mydevice/some_file.txt ~/
```

#### 4. Размонтирование устройства (безопасное отключение)

**ВАЖНО:** Перед физическим отключением устройства его необходимо размонтировать. Это гарантирует, что все данные были записаны на носитель, и предотвращает потерю данных или повреждение файловой системы.

Используйте команду `umount`. Указывать можно либо имя устройства, либо точку монтирования.

```bash
# Используя точку монтирования (рекомендуется)
sudo umount /mnt/mydevice

# Или используя имя устройства
sudo umount /dev/sdb1
```

После выполнения этой команды вы можете безопасно извлечь устройство.

#### 5. Форматирование устройства (создание файловой системы)

**ВНИМАНИЕ!** Форматирование — это процесс, который **полностью и безвозвратно уничтожает ВСЕ данные** на выбранном разделе. Убедитесь, что вы выбрали правильное устройство и раздел, и что вы сохранили все важные данные.

Форматирование подготавливает раздел к использованию, создавая на нем новую файловую систему. Команда для этого - `mkfs` (make filesystem).

**a) Основной синтаксис:**

```bash
# Указывать нужно конкретный раздел, например /dev/sdb1
sudo mkfs.<ТИП_ФС> /dev/sdXN
```
*Где `ТИП_ФС` — это тип файловой системы (например, `ext4`, `ntfs`), а `/dev/sdXN` — ваш раздел.*

**b) Примеры для разных файловых систем:**

*   **ext4:** Стандартная файловая система для Linux.
    ```bash
    sudo mkfs.ext4 /dev/sdb1
    ```

*   **FAT32 (vfat):** Совместима с большинством устройств и систем, но не поддерживает файлы размером более 4 ГБ.
    ```bash
    sudo mkfs.vfat -F 32 /dev/sdb1
    ```

*   **exFAT:** Современная файловая система, совместимая с Windows, macOS и Linux, без ограничения на размер файла в 4 ГБ. Идеально для флешек.
    ```bash
    sudo mkfs.exfat /dev/sdb1
    ```

*   **NTFS:** Файловая система Windows. Хорошо поддерживается в Linux.
    ```bash
    sudo mkfs.ntfs /dev/sdb1
    ```

**c) Форматирование в NixOS:**

В NixOS утилиты для форматирования (например, `mkfs.ntfs` или `mkfs.exfat`) могут отсутствовать в базовой системе. Чтобы их использовать, лучше всего войти во временную оболочку `nix-shell`:

```bash
# 1. Определите, какая утилита вам нужна.
#    - Для FAT32: пакет `dosfstools`
#    - Для exFAT: пакет `exfatprogs`
#    - Для NTFS: пакет `ntfsprogs`

# 2. Запустите nix-shell с нужным пакетом и выполните команду.
# Пример для форматирования в NTFS:
nix-shell -p ntfsprogs --run "sudo mkfs.ntfs -f /dev/sdb1"

# Пример для форматирования в exFAT:
nix-shell -p exfatprogs --run "sudo mkfs.exfat /dev/sdb1"
```

#### 6. Устранение распространенных ошибок

При работе с файлами на съемных носителях, особенно отформатированных в файловых системах, отличных от родных для Linux (например, FAT32, exFAT, NTFS), могут возникать специфические ошибки.

##### Ошибка `Operation not permitted` при использовании `rsync`

*   **Проблема:** При копировании файлов с помощью `rsync -a` возникает ошибка `rsync: [generator] chown "..." failed: Operation not permitted (1)`.
*   **Причина:** Флаг `-a` является псевдонимом для `-rlptgoD`, который пытается сохранить владельца (`-o`) и группу (`-g`) исходных файлов. Файловые системы, часто используемые на USB-накопителях (FAT32, exFAT, NTFS), не поддерживают смену владельца в стиле Linux, что и вызывает ошибку.
*   **Решение:** Добавьте флаги `--no-o` и `--no-g` к вашей команде `rsync`, чтобы отключить сохранение владельца и группы.

    ```bash
    # Пример копирования с исправлением ошибки прав
    sudo rsync -a --no-o --no-g --info=progress2 /path/to/source /path/to/destination
    ```

##### Ошибка `Invalid argument` при создании каталога или файла

*   **Проблема:** При копировании или создании файлов на съемном носителе возникает ошибка `mkdir ... failed: Invalid argument (22)` или похожая.
*   **Причина:** Имена файлов или каталогов содержат символы, которые не поддерживаются целевой файловой системой (например, `?`, `*`, `:`, `"` или не-ASCII символы, которые могут отображаться как `?`).
*   **Решение:** Найдите и переименуйте файлы с недопустимыми именами перед копированием.

    1.  **Найдите проблемные файлы:** Используйте `ls -R` для рекурсивного просмотра содержимого исходного каталога. Обращайте внимание на имена с вопросительными знаками или странными символами.
        ```bash
        ls -R /path/to/source
        ```
    2.  **Переименуйте файлы:** Используйте команду `mv`. Если имя содержит пробелы или специальные символы, обязательно заключите его в кавычки.
        ```bash
        # Пример переименования файла с некорректным именем
        mv "/path/to/source/файл с ???.txt" "/path/to/source/new_correct_name.txt"
        ```
