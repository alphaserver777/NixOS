# Руководство по базовой диагностике системы в NixOS

Этот документ поможет вам самостоятельно диагностировать и решать распространенные проблемы с системой, такие как зависания, сбои приложений или подозрения на аппаратные неисправности. Мы будем использовать тот же подход, который применяли для решения вашей проблемы.

## Основные принципы

Диагностика — это процесс исключения.

1.  **Наблюдайте за симптомами:** Когда именно возникают проблемы? Что им предшествует?
2.  **Ищите доказательства:** Проверяйте системные журналы на наличие ошибок, совпадающих по времени с проблемой.
3.  **Формируйте гипотезу:** Основываясь на ошибках, предположите причину (например, "проблема с диском" или "сбой драйвера видеокарты").
4.  **Проверяйте гипотезу:** Используйте специальные команды для проверки конкретного компонента (например, тест диска) или выполните откат системы, чтобы проверить, не вызван ли сбой обновлением.

---

## Шаг 1: Проверка системных журналов

Это первое, что нужно делать. Системный журнал фиксирует ошибки от ядра и всех системных служб.

### Основная команда: `journalctl`

-   **Посмотреть 100 последних сообщений об ошибках с текущей загрузки:**
    ```bash
    journalctl -p 3 -b -r -n 100
    ```
    -   `-p 3`: Показать сообщения с приоритетом "ошибка" (error) и выше.
    -   `-b`: Показать сообщения только с текущей загрузки системы.
    -   `-r`: Вывести логи в обратном порядке (самые новые сначала).
    -   `-n 100`: Ограничить вывод 100 строками.

-   **Посмотреть только ошибки ядра (драйверы, оборудование):**
    ```bash
    journalctl -k -b -r -p 3
    ```
    -   `-k`: Показать только сообщения от ядра Linux.

**На что обращать внимание:** Ищите ключевые слова `error`, `failed`, `timeout`. Часто в сообщении об ошибке упоминается имя устройства или драйвера (например, `nvidia`, `i2c`, `ucsi_ccg`, `sdc`).

---

## Шаг 2: Проверка состояния дисков (S.M.A.R.T.)

Если система тормозит, приложения не запускаются или есть ошибки ввода-вывода в `journalctl`, стоит проверить "здоровье" дисков.

1.  **Определить имя диска:**
    ```bash
    lsblk -f
    ```
    Эта команда покажет все диски (`/dev/sda`, `/dev/sdb` и т.д.) и их разделы.

2.  **Запросить отчет S.M.A.R.T.:**
    Для проверки диска `/dev/sdb` выполните:
    ```bash
    sudo smartctl -a /dev/sdb
    ```
    Если `smartctl` не установлен:
    ```bash
    nix-shell -p smartmontools --run "sudo smartctl -a /dev/sdb"
    ```

**На что обращать внимание в отчете:**
-   `SMART overall-health self-assessment test result`: Должно быть `PASSED`.
-   `Reallocated_Sector_Ct`: `RAW_VALUE` в идеале должен быть `0`. Рост этого значения — плохой знак.
-   `UDMA_CRC_Error_Count`: `RAW_VALUE` должен быть `0`. Если значение растет, это указывает на проблемы с кабелем или подключением диска.

---

## Шаг 3: Определение оборудования

Знание точной модели комплектующих помогает искать известные проблемы в интернете.

-   **Определить видеокарту:**
    ```bash
    lspci -k | grep -A 2 -E "(VGA|3D)"
    ```

-   **Определить модель материнской платы/компьютера:**
    ```bash
    sudo dmidecode -t system
    ```
    Если `dmidecode` не установлен:
    ```bash
    nix-shell -p dmidecode --run "sudo dmidecode -t system"
    ```

---

## Шаг 4: Откат системы (Главное преимущество NixOS)

Если проблемы начались после обновления, самый быстрый способ это проверить — откатиться на предыдущее "поколение" системы.

1.  **Посмотреть список поколений:**
    ```bash
    sudo nix-env -p /nix/var/nix/profiles/system --list-generations
    ```
    Вы увидите список поколений с датами их создания.

2.  **Выбрать и загрузить старое поколение:**
    -   Найдите в списке поколение, созданное до того, как начались проблемы.
    -   **Перезагрузите компьютер.**
    -   В меню загрузки (GRUB) выберите нужное поколение по его номеру.

3.  **Закрепить результат:**
    Если старое поколение работает стабильно, загрузитесь в него и выполните команду:
    ```bash
    sudo nixos-rebuild switch
    ```
    Это сделает текущее (стабильное) поколение новым поколением по умолчанию.
